const playerStats = {
    level: 1,
    hp: 100,
    maxHp: 100,
    mana: 20,
    maxMana: 20,
    gold: 0,
    xp: 0,
    weapon: null,
    buffs: {},
    inventory: {
        "poção de cura": 3,
        "elixir de força": 0
    },
    playerClass: null
};

const CLASSES = {
    "guerreiro": {
        bonus_hp: 30,
        dano_extra: 5,
        mana_max: 20,
        habilidade: {
            nome: "Golpe Poderoso",
            custo: 10,
            efeito: "dobro_dano_proximo_ataque"
        },
    },
    "arqueiro": {
        bonus_hp: 0,
        dano_extra: 0,
        mana_max: 30,
        habilidade: {
            nome: "Tiro Preciso",
            custo: 15,
            efeito: "garante_critico_proximo_ataque"
        },
        critico_chance: 0.3,
        critico_dano: 2,
    }
};

const WEAPONS = {
    "espada de madeira": {
        dano_min: 5,
        dano_max: 10,
        valor: 10,
    },
    "espada de aço": {
        dano_min: 15,
        dano_max: 25,
        valor: 100,
    },
    "arco curto": {
        dano_min: 5,
        dano_max: 15,
        valor: 10,
    },
    "arco longo": {
        dano_min: 10,
        dano_max: 30,
        valor: 100,
    }
};

const ENEMIES = {
    "goblin": {
        hp: 50,
        dano_min: 5,
        dano_max: 15,
        xp_drop: 20,
        gold_drop_min: 5,
        gold_drop_max: 15,
        loot_chance: {"poção de cura": 0.3, "elixir de força": 0.1}
    },
    "orc": {
        hp: 80,
        dano_min: 10,
        dano_max: 25,
        xp_drop: 50,
        gold_drop_min: 10,
        gold_drop_max: 25,
        loot_chance: {"poção de cura": 0.4, "elixir de força": 0.2, "espada de aço": 0.05}
    },
    "troll": {
        hp: 120,
        dano_min: 15,
        dano_max: 35,
        xp_drop: 80,
        gold_drop_min: 20,
        gold_drop_max: 40,
        loot_chance: {"poção de cura": 0.5, "elixir de força": 0.3, "arco longo": 0.05}
    },
    "dragão": {
        hp: 300,
        dano_min: 30,
        dano_max: 60,
        xp_drop: 200,
        gold_drop_min: 100,
        gold_drop_max: 200,
        loot_chance: {"poção de cura": 1.0, "elixir de força": 0.5, "espada de aço": 0.2, "arco longo": 0.2}
    }
};

let currentEnemy = null;

const playerLevelEl = document.getElementById('player-level');
const playerHpEl = document.getElementById('player-hp');
const playerMaxHpEl = document.getElementById('player-max-hp');
const playerManaEl = document.getElementById('player-mana');
const playerMaxManaEl = document.getElementById('player-max-mana');
const playerGoldEl = document.getElementById('player-gold');
const gameTextEl = document.getElementById('game-text');
const optionsContainer = document.querySelector('.options-container');

function updateUI() {
    playerLevelEl.textContent = playerStats.level;
    playerHpEl.textContent = playerStats.hp;
    playerMaxHpEl.textContent = playerStats.maxHp;
    playerManaEl.textContent = playerStats.mana;
    playerMaxManaEl.textContent = playerStats.maxMana;
    playerGoldEl.textContent = playerStats.gold;
}

function renderButtons(options) {
    optionsContainer.innerHTML = '';
    options.forEach(option => {
        const button = document.createElement('button');
        button.className = 'action-button';
        button.textContent = option.text;
        button.onclick = option.action;
        optionsContainer.appendChild(button);
    });
}

function showMessage(message) {
    gameTextEl.textContent = message;
}

// --- Funções de Lógica do Jogo (Adaptadas de Python para JavaScript) ---
function chooseClass() {
    showMessage("Escolha sua classe para começar a aventura:");
    renderButtons([
        { text: "Guerreiro", action: () => setClass("guerreiro") },
        { text: "Arqueiro", action: () => setClass("arqueiro") }
    ]);
}

function setClass(className) {
    playerStats.playerClass = CLASSES[className];
    playerStats.maxHp = 100 + playerStats.playerClass.bonus_hp;
    playerStats.hp = playerStats.maxHp;
    playerStats.maxMana = playerStats.playerClass.mana_max;
    playerStats.mana = playerStats.maxMana;
    updateUI();
    showMessage(`Você escolheu a classe ${className.toUpperCase()}!`);
    setTimeout(chooseWeapon, 1500);
}

function chooseWeapon() {
    showMessage("Você encontrou uma Espada de Madeira e um Arco Curto. Qual arma você quer levar?");
    renderButtons([
        { text: "Espada de Madeira", action: () => setWeapon("espada de madeira") },
        { text: "Arco Curto", action: () => setWeapon("arco curto") }
    ]);
}

function setWeapon(weaponName) {
    playerStats.weapon = WEAPONS[weaponName];
    showMessage(`Você equipou o(a) ${weaponName}!`);
    setTimeout(mainMenu, 1500);
}

function mainMenu() {
    showMessage("O que você quer fazer?");
    renderButtons([
        { text: "Aventure-se", action: () => startBattle() },
        { text: "Visitar Loja", action: () => visitShop() },
        { text: "Descansar", action: () => rest() }
    ]);
}

function startBattle() {
    const availableEnemies = ["goblin"];
    if (playerStats.level >= 2) availableEnemies.push("orc");
    if (playerStats.level >= 3) availableEnemies.push("troll");
    if (playerStats.level >= 5) availableEnemies.push("dragão");
    
    const enemyType = availableEnemies[Math.floor(Math.random() * availableEnemies.length)];
    currentEnemy = { ...ENEMIES[enemyType], type: enemyType };
    showMessage(`Um ${enemyType.toUpperCase()} aparece!`);
    setTimeout(battleLoop, 1500);
}

function battleLoop() {
    if (playerStats.hp <= 0) {
        showMessage("Você morreu... Fim de jogo.");
        renderButtons([]);
        return;
    }
    if (currentEnemy.hp <= 0) {
        endBattle();
        return;
    }

    showMessage(`Você encontrou um ${currentEnemy.type}. Sua vida: ${playerStats.hp}/${playerStats.maxHp}. Vida do inimigo: ${currentEnemy.hp}.`);
    
    const battleOptions = [
        { text: "Atacar", action: () => playerTurn() },
        { text: "Poção", action: () => usePotion() },
        { text: "Elixir", action: () => useElixir() },
        { text: playerStats.playerClass.habilidade.nome, action: () => useAbility() },
        { text: "Fugir", action: () => flee() }
    ];
    renderButtons(battleOptions);
}

function playerTurn() {
    let finalDamage = Math.floor(Math.random() * (playerStats.weapon.dano_max - playerStats.weapon.dano_min + 1)) + playerStats.weapon.dano_min + playerStats.playerClass.dano_extra;
    
    if (playerStats.buffs.dobro_dano_proximo_ataque) {
        finalDamage *= 2;
    }
    if (playerStats.buffs.garante_critico || (playerStats.playerClass.critico_chance && Math.random() < playerStats.playerClass.critico_chance)) {
        finalDamage *= playerStats.playerClass.critico_dano;
    }

    currentEnemy.hp -= finalDamage;
    showMessage(`Você ataca o ${currentEnemy.type} e causa ${Math.floor(finalDamage)} de dano!`);

    for (const buff in playerStats.buffs) {
        if (playerStats.buffs[buff] === true) {
            delete playerStats.buffs[buff];
        }
    }
    
    setTimeout(enemyTurn, 1500);
}

function enemyTurn() {
    if (currentEnemy.hp <= 0) {
        battleLoop();
        return;
    }
    const enemyDamage = Math.floor(Math.random() * (currentEnemy.dano_max - currentEnemy.dano_min + 1)) + currentEnemy.dano_min;
    playerStats.hp -= enemyDamage;
    if (playerStats.hp < 0) playerStats.hp = 0;
    
    updateUI();
    showMessage(`O ${currentEnemy.type} contra-ataca e te causa ${enemyDamage} de dano!`);
    setTimeout(battleLoop, 1500);
}

function endBattle() {
    showMessage(`Você derrotou o ${currentEnemy.type}!`);
    playerStats.xp += currentEnemy.xp_drop;
    playerStats.gold += Math.floor(Math.random() * (currentEnemy.gold_drop_max - currentEnemy.gold_drop_min + 1)) + currentEnemy.gold_drop_min;
    
    // Simplificando o loot
    for (const item in currentEnemy.loot_chance) {
        if (Math.random() <= currentEnemy.loot_chance[item]) {
            showMessage(`Você encontrou um(a) ${item.toUpperCase()}!`);
            if (WEAPONS[item]) {
                playerStats.weapon = WEAPONS[item];
                showMessage(`Você equipou o(a) ${item.toUpperCase()}!`);
            } else {
                playerStats.inventory[item]++;
            }
        }
    }

    updateUI();
    setTimeout(mainMenu, 2500);
}

function usePotion() {
    if (playerStats.inventory["poção de cura"] > 0) {
        const healAmount = 30;
        playerStats.hp += healAmount;
        if (playerStats.hp > playerStats.maxHp) playerStats.hp = playerStats.maxHp;
        playerStats.inventory["poção de cura"]--;
        updateUI();
        showMessage(`Você usa uma poção e recupera ${healAmount} de vida. Restam ${playerStats.inventory["poção de cura"]} poções.`);
        setTimeout(enemyTurn, 1500);
    } else {
        showMessage("Você não tem poções de cura!");
        setTimeout(battleLoop, 1500);
    }
}

function useElixir() {
    if (playerStats.inventory["elixir de força"] > 0) {
        playerStats.buffs["força"] = 3;
        playerStats.inventory["elixir de força"]--;
        showMessage("Você bebeu o Elixir de Força! Seus próximos ataques serão mais fortes por 3 turnos.");
        setTimeout(enemyTurn, 1500);
    } else {
        showMessage("Você não tem Elixires de Força!");
        setTimeout(battleLoop, 1500);
    }
}

function useAbility() {
    const ability = playerStats.playerClass.habilidade;
    if (playerStats.mana >= ability.custo) {
        playerStats.mana -= ability.custo;
        playerStats.buffs[ability.efeito] = true;
        updateUI();
        showMessage(`Você usa a habilidade ${ability.nome}!`);
        setTimeout(enemyTurn, 1500);
    } else {
        showMessage("Mana insuficiente!");
        setTimeout(battleLoop, 1500);
    }
}

function flee() {
    showMessage("Você tenta fugir...");
    if (Math.random() > 0.5) {
        showMessage("Você conseguiu fugir da batalha!");
        setTimeout(mainMenu, 1500);
    } else {
        showMessage("A fuga falhou! O inimigo te impede de sair.");
        setTimeout(enemyTurn, 1500);
    }
}

function visitShop() {
    showMessage("Bem-vindo à loja!");
    const shopOptions = [
        { text: `Poção de Cura (${SHOP_ITEMS["poção de cura"].valor} ouro)`, action: () => buyItem("poção de cura") },
        { text: `Elixir de Força (${SHOP_ITEMS["elixir de força"].valor} ouro)`, action: () => buyItem("elixir de força") },
        { text: `Espada de Aço (${SHOP_ITEMS["espada de aço"].valor} ouro)`, action: () => buyItem("espada de aço") },
        { text: `Arco Longo (${SHOP_ITEMS["arco longo"].valor} ouro)`, action: () => buyItem("arco longo") },
        { text: "Voltar", action: () => mainMenu() }
    ];
    renderButtons(shopOptions);
}

function buyItem(item) {
    const cost = SHOP_ITEMS[item].valor;
    if (playerStats.gold >= cost) {
        playerStats.gold -= cost;
        if (WEAPONS[item]) {
            playerStats.weapon = WEAPONS[item];
            showMessage(`Você comprou e equipou ${item.toUpperCase()}!`);
        } else {
            playerStats.inventory[item]++;
            showMessage(`Você comprou ${item.toUpperCase()}!`);
        }
        updateUI();
    } else {
        showMessage("Você não tem ouro suficiente!");
    }
    setTimeout(visitShop, 1500);
}

function rest() {
    playerStats.hp = playerStats.maxHp;
    playerStats.mana = playerStats.maxMana;
    updateUI();
    showMessage("Sua vida e mana foram totalmente restauradas.");
    setTimeout(mainMenu, 1500);
}

// Início do Jogo
chooseClass();